<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
	<link href="css/normalize.css" media="screen, print" rel="stylesheet" type="text/css" />
	<link href="css/gauntlet.css"  media="screen, print" rel="stylesheet" type="text/css" />
	<link href="css/loth.css" rel="stylesheet" type="text/css"  />
	<title>Javascript Gauntlet 3D</title>
</head>

<body>
<div id="viewport"></div>
<div id="hubs">
	<div id="debug"></div>
	<div id="gui"></div>
	<div id="home"><a href="index.html"><img id="logo" src="res/img/home.png" onmouseover="this.src='res/img/home_s.png'" onmouseout="this.src='res/img/home.png'" /></a></div>
	<div id="info">
	GAUNTLET 3D 0.1a <a href="http://3dflashlo.wordpress.com/" target="_blank">Â®loth 2013</a>
	| <a href="https://code.google.com/p/sea3d/" target="_blank">sea3d</a> 
	. <a href="http://github.com/mrdoob/three.js" target="_blank">three.js</a> 
	| <a href="https://github.com/jakesgordon/javascript-gauntlet/" target="_blank">Gauntlet source</a> 
	</div>
	<div id="loading"><img src="res/img/loader.gif" alt="Loading SEA3D File." style="visibility: hidden;"></div>
</div>

<div id="gauntlet">
	<img id="booting" src='res/img/loader.gif'>
	<img id="splash"  src='res/images/splash0.png'>
	<canvas id="canvas">
		<div class="unsupported">Sorry, this example cannot be run because your browser does not support the &lt;canvas&gt; element</div>
	</canvas>
	<div id="help" style="display:none;"></div>
	<div id="scoreboard">
		<img id="logo" src="res/images/logo.png">
		<h3 class="level"> &nbsp; </h3>
		<hr>
		<div class="high">High Score: <span class='value'>000000</span></div>
		<div id='warrior' class='player'>
			<div class='name'>Warrior</div>
			<div class='score'><div class='label'>Score</div><div class='value'>000000</div></div>
			<div class='health'><div class='label'>Health</div><div class='value'>000</div></div>
			<div class='treasure'>
				<img class='key' src="res/images/key.png"><img class='key' src="res/images/key.png"><img class='key' src="res/images/key.png"><img class='key' src="res/images/key.png">
				<img class='potion' src="res/images/potion.png"><img class='potion' src="res/images/potion.png"><img class='potion' src="res/images/potion.png"><img class='potion' src="res/images/potion.png">
			</div>
			<div class='press'>PRESS <b>1</b> TO START</div>
			<div class='multi'>multiplayer coming soon</div>
		</div>
		<div id='valkyrie' class='player'>
			<div class='name'>Valkyrie</div>
			<div class='score'><div class='label'>Score</div><div class='value'>000000</div></div>
			<div class='health'><div class='label'>Health</div><div class='value'>000</div></div>
			<div class='treasure'>
				<img class='key' src="res/images/key.png"><img class='key' src="res/images/key.png"><img class='key' src="res/images/key.png"><img class='key' src="res/images/key.png">
				<img class='potion' src="res/images/potion.png"><img class='potion' src="res/images/potion.png"><img class='potion' src="res/images/potion.png"><img class='potion' src="res/images/potion.png">
			</div>
			<div class='press'>PRESS <b>2</b> TO START</div>
			<div class='multi'>multiplayer coming soon</div>
		</div>
		<div id='wizard' class='player'>
			<div class='name'>Wizard</div>
			<div class='score'><div class='label'>Score</div><div class='value'>000000</div></div>
			<div class='health'><div class='label'>Health</div><div class='value'>000</div></div>
			<div class='treasure'>
				<img class='key' src="res/images/key.png"><img class='key' src="res/images/key.png"><img class='key' src="res/images/key.png"><img class='key' src="res/images/key.png">
				<img class='potion' src="res/images/potion.png"><img class='potion' src="res/images/potion.png"><img class='potion' src="res/images/potion.png"><img class='potion' src="res/images/potion.png">
			</div>
			<div class='press'>PRESS <b>3</b> TO START</div>
			<div class='multi'>multiplayer coming soon</div>
		</div>
		<div id='elf' class='player'>
			<div class='name'>Elf</div>
			<div class='score'><div class='label'>Score</div><div class='value'>000000</div></div>
			<div class='health'><div class='label'>Health</div><div class='value'>000</div></div>
			<div class='treasure'>
				<img class='key' src="res/images/key.png"><img class='key' src="res/images/key.png"><img class='key' src="res/images/key.png"><img class='key' src="res/images/key.png">
				<img class='potion' src="res/images/potion.png"><img class='potion' src="res/images/potion.png"><img class='potion' src="res/images/potion.png"><img class='potion' src="res/images/potion.png">
			</div>
			<div class='press'>PRESS <b>4</b> TO START</div>
			<div class='multi'>multiplayer coming soon</div>
		</div>
		<div id='sound' class='on' title='toggle music and fx'>
			<img id="soundIn" src='res/img/son.png'>
		</div>
	</div>
</div>


<!-- _     _   _      ___ __  _ ____
    | |___| |_| |__  |_  )  \/ |__ /
    | / _ \  _|    |  / / () | ||_ \
    |_\___/\__|_||_| /___\__/|_|___/
--> 

<script src="js/three.min.js"></script>

<script src="js/loaders/sea3d/SEA3D.js"></script>
<script src="js/loaders/sea3d/SEA3DLoader.js"></script>
<script src="js/loaders/sea3d/SEA3DDeflate.js"></script>
<script src="js/loaders/sea3d/SEA3DLZMA.js"></script> 

<script src="js/gauntlet/vendor.js"></script>
<script src="js/gauntlet/game.js"></script>
<script src="js/gauntlet/gauntlet.js"></script>

<script src='js/libs/dat.gui.min.js'></script>

<script>
      

	var vsize = { x:100, y:100, z:0 };
	var mouse = { x:0, y:0, move:true };
	var camera, controls, target, scene, renderer, composer, renderPass, delta, pointLight, pointLight2, spotLight, renderLoop;
	var clock = new THREE.Clock();


	var Colors= [0x161616, 0x333333, 0x606060];
	//---------- Bakground, Ambient, Specular

	var materials = [];

	var generator = [];
	var treasure = [];
	var monster = [];
	var weapon = [];
	var exit = [];
	var door = [];
	var fx = [];

	var players = [];
	var grounds = [];

	var loader;

	var tEntities = [];

	var level, player, intro;
	var meshs=[];

	var list ="";

	var projector, raycaster;
	var mouse = new THREE.Vector2(), INTERSECTED;
	var radius = 100, theta = 0;
	var isIntro;

	var viewConfig = {
		show2d : false,
		showInfo : false
	}

	var camConfig = {
		horizontal : 45,
		vertical : 90,
		distance : 200
	}

	/*function init() {
		//initScene3D();
		document.getElementById("canvas").style.visibility = "hidden";
		//document.getElementById("scoreboard").style.visibility = "hidden";
		tell("<b>1,2,3,4</b> choose player<br><b>ARROW</b> keys to move<br><b>HOLD SPACE</b> to fire<br><b>ENTER</b> to use potion");
	}*/

	function init3D() {
		if(!renderer){
			setTimeout(initScene3D, 100);
			document.getElementById("canvas").style.visibility = "hidden";
			document.getElementById("scoreboard").style.visibility = "hidden";
			tell("<b>Choose player</b> <br><b>ARROW</b> keys to move<br><b>HOLD SPACE</b> to fire<br><b>ENTER</b> to use potion");
		}
	}

	function initScene3D() {
		vsize.x = window.innerWidth;
		vsize.y = window.innerHeight-31;
		vsize.z = vsize.x / vsize.y;

		renderer = new THREE.WebGLRenderer({ antialias: false, alpha: false });
		renderer.setSize( vsize.x, vsize.y );
		renderer.setClearColor( Colors[0], 1 );
		renderer.physicallyBasedShading = true;
		renderer.gammaInput = true;
		renderer.gammaOutput = true;
		renderer.shadowMapEnabled = true;
		//renderer.shadowMapCascade = true;
		//renderer.shadowMapType = THREE.PCFSoftShadowMap;
		//renderer.shadowMapSoft = true;
		renderer.sortObjects = false;
		//renderer.shadowMapCullFace = THREE.CullFaceBack;

		document.getElementById( 'viewport' ).appendChild( renderer.domElement );
		renderer.domElement.style.top = 31 + "px";
		renderer.domElement.style.position = "absolute";

		// SCENE
		scene = new THREE.Scene();
		//scene.fog = new THREE.Fog(  Colors[0], 300, 500 );

		projector = new THREE.Projector();
		raycaster = new THREE.Raycaster();

		// CAMERA
		camera = new THREE.PerspectiveCamera( 70, vsize.z, 1, 2000 );
		camera.position.z = 100;
		camera.position.y = 200;
		//scene.add(camera);

		target = new THREE.Object3D();
		scene.add(target);
		
		var ambient = new THREE.AmbientLight( Colors[0] );
		scene.add( ambient );

		//spotLight = new THREE.DirectionalLight(0x000, 1.5);
		spotLight = new THREE.SpotLight( 0xffffff );
		spotLight.intensity = 1;
		spotLight.position.set(100,200,50);
		spotLight.target = target;
		spotLight.castShadow = true;

		spotLight.shadowCameraNear = 100;
		spotLight.shadowCameraFar = 300;
		spotLight.shadowCameraFov = 75;

		spotLight.shadowMapBias = 0.01;
		spotLight.shadowMapDarkness = 0.7;
		spotLight.shadowMapWidth = 1024;
		spotLight.shadowMapHeight = 1024;

		/*spotLight.shadowCascade = true;
		spotLight.shadowCascadeCount = 3;
		spotLight.shadowCascadeNearZ = [ -1.000, 0.995, 0.998 ];
		spotLight.shadowCascadeFarZ  = [  0.995, 0.998, 1.000 ];
		spotLight.shadowCascadeWidth = [ 1024, 1024, 1024 ];
		spotLight.shadowCascadeHeight = [ 1024, 1024, 1024 ];*/
		//spotLight.shadowCameraVisible = true; 

		//spotLight.onlyShadow= true;
		target.add(spotLight);
		//scene.add(spotLight);


	    pointLight = new THREE.PointLight( 0xffffff, 1, 200 );
		pointLight.position.set( 0, 30, 0 );
		target.add( pointLight );

		/*pointLight2 = new THREE.PointLight( 0xffffff, 3, 150 );
		pointLight2.position.set( 0, 0, 0 );
		target3.add( pointLight2 );*/


		initMaterial();
		initSea3DMesh();

		addGUI();
		addGUIView();
		addGUICamera();

		window.addEventListener( 'resize', onResize, false );
	}

	//===========================================================================
	// RENDER LOOP
	//===========================================================================

	function startRender() {
		if(!renderLoop) renderLoop = setInterval( function () { requestAnimationFrame( animate ); }, 1000 / 60 );
	}

	function stopRender() {
		if(renderLoop) {clearInterval(renderLoop); renderLoop = null;}
	}

	function animate() {
		delta = clock.getDelta();
		THREE.AnimationHandler.update( delta );
		
		camera.position.copy( Orbit( target.position, camConfig.horizontal, camConfig.vertical, camConfig.distance ) );
		camera.lookAt( target.position );

		// find intersections if intro
		if(isIntro){
			var vector = new THREE.Vector3( mouse.x, mouse.y, 1 );
			projector.unprojectVector( vector, camera );
			raycaster.set( camera.position, vector.sub( camera.position ).normalize() );
			var intersects = raycaster.intersectObjects( intro.children );

			if ( intersects.length > 0 ) {
				if ( INTERSECTED != intersects[ 0 ].object ) {
					if ( INTERSECTED ){ 
						INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
						intro3DIdle();
					}
					INTERSECTED = intersects[ 0 ].object;
					INTERSECTED.currentHex = INTERSECTED.material.emissive.getHex();
					INTERSECTED.material.emissive.setHex( 0xff0000 );
					//list = ("select "+INTERSECTED.name);
					if(players.length>0){
						if ( INTERSECTED.name === "G0" )if(players[0].currentAnimation.name !== "walk") players[0].play("walk");
						if ( INTERSECTED.name === "G1" )if(players[1].currentAnimation.name !== "walk") players[1].play("walk");
						if ( INTERSECTED.name === "G2" )if(players[2].currentAnimation.name !== "walk") players[2].play("walk");
						if ( INTERSECTED.name === "G3" )if(players[3].currentAnimation.name !== "walk") players[3].play("walk");
				    }
				}
			} else {
				if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
				INTERSECTED = null;
				intro3DIdle();
			}
		}

		renderer.render( scene, camera );
		//tell(list);
	}

	//===========================================================================
	// LISTENERS
	//===========================================================================

	function onResize( event ) {
		vsize.x = window.innerWidth;
		vsize.y = window.innerHeight-31;
		vsize.z = vsize.x / vsize.y;
		camera.aspect = vsize.z;
		camera.updateProjectionMatrix();
		renderer.setSize( vsize.x, vsize.y );
	}

	function onDocumentMouseMove( event ) {
		event.preventDefault();
		mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
		mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
	}

	function onDocumentMouseDown( event ) {
		if(isIntro && INTERSECTED !== null ){
			if ( INTERSECTED.name === "G0" ) window.game.playPlayer(0);
			if ( INTERSECTED.name === "G1" ) window.game.playPlayer(1);
			if ( INTERSECTED.name === "G2" ) window.game.playPlayer(2);
			if ( INTERSECTED.name === "G3" ) window.game.playPlayer(3);
		}
	}

	//===========================================================================
	//
	// MATERIALS
	//
	//===========================================================================

	function initMaterial( ) {

	    materials[0] = makeMaterial("avatar1.jpg", null, true);// player 0 / 1;
		materials[1] = makeMaterial("avatar2.jpg", null, true);// player 2 / 3;

		//materials[2] = makeMaterial("wall.jpg", "wall_n.jpg");// wall
		materials[2] = makeMaterial("wall.jpg", null, false, 150, null, false, true);// wall bump
		//materials[3] = makeMaterial("floor_128.jpg", "floor_128_n.jpg");// floor
		materials[3] = makeMaterial("floor_128.jpg", null, false, 150, null, false, true);// floor bump

		materials[4] = makeMaterial("avatar3.jpg", null, true);// monster 4 / 5
		materials[5] = makeMaterial("avatar4.jpg", null, true);// monster 6 / 7
		materials[6] = makeMaterial("avatar5.jpg", null, true);// monster 8 

		//materials[7] = makeMaterial("stairs.jpg", "stairs_n.jpg");// exit and door
		materials[7] = makeMaterial("stairs.jpg", null, false, 150, null, false, true);// exit and door bump
		materials[8] = makeMaterial(null, null, false, 60, 0xffff00);// treasure

		materials[9] = makeMaterial("exp.png", null, false, 60, null, true);// fx
		materials[10] = makeMaterial(null, null, false, 60, 0x0000ff);// weapon
		materials[11] = makeMaterial(null, null, false, 60, 0x00ffff);// generator

		materials[12] = makeMaterial(null, null, false, 10, 0x606060);// Guns

		//materials[30] = makeMaterial(null, null, false, 60, 0xF90503);
		//intro
		materials[20] = makeMaterial(null, null, false, 60, 0xF90503);
		materials[21] = makeMaterial(null, null, false, 60, 0x08B4F0);
		materials[22] = makeMaterial(null, null, false, 60, 0xF5FC00);
		materials[23] = makeMaterial(null, null, false, 60, 0x00FF03);

	}

	function makeMaterial (diffuse, normal, skin, shine, color, transparent, bump){
		var map, map2;
		var material = new THREE.MeshPhongMaterial( { ambient: Colors[1], specular: Colors[2], shininess: shine || 60 } );

		if(diffuse) {
			map = THREE.ImageUtils.loadTexture( 'res/textures/game/'+ diffuse );
		    map.repeat.set( 1, -1 );
		    map.wrapS = map.wrapT = THREE.RepeatWrapping;
		    map.anisotropy = renderer.getMaxAnisotropy();
		    material.map = map;
		}

		if(bump){
			 material.bumpMap = map;
			 material.bumpScale = 3;
		}

		if(normal) {
			map2 = THREE.ImageUtils.loadTexture( 'res/textures/game/'+ normal );
		    map2.repeat.set( 1, -1 );
		    map2.wrapS = map2.wrapT = THREE.RepeatWrapping;
		    map2.anisotropy = renderer.getMaxAnisotropy();
		    material.normalMap = map2;
		    material.normalScale.x = material.normalScale.y = 2;
		}

		if(skin) material.skinning = true;
		if(color) material.color.setHex( color );
		if(transparent) material.transparent = transparent;

		return material;
	}

	//===========================================================================
	// IMPORT SEA3D ASSETS
	//===========================================================================

	function initSea3DMesh() {

		//var 
		loader = new THREE.SEA3D( false );
		var size = 1;
		var i;
		//list = "";

		loader.onComplete = function( e ) {
			// 0 -> 15 walls
			// 16 -> 23 treasure
			// 24 - 25 doors
			// 26 exit
			// 27 -> 30 Hero 
			// 31 -> 35 Monster 
			// 36 - floor
			for (i=0; i < loader.meshes.length; i++){
				meshs[i] = loader.meshes[i];
				if(meshs[i].name !== "weapon0" && meshs[i].name !== "weapon1" && meshs[i].name !== "weapon2" && meshs[i].name !== "weapon3") 
					meshs[i].scale.set( size, size, -size );
				else meshs[i].material = materials[12];
				//list += i + ":"+meshs[i].name+"<br>";
			}
			//tell(list);
			intro3D();

			document.getElementById("scoreboard").style.visibility = "visible";
		};
		loader.load( 'res/models/gauntlet_dog_nomat.sea' );
	}

	//===========================================================================
	// INTRO
	//===========================================================================

	function intro3D(){
		intro = new THREE.Object3D();
		scene.add(intro);

		for (var i = 0; i<4; i++){
			players[i] = meshs[27+i];
			if(i===27 || i===28) players[i].material = materials[0];
			else players[i].material =  materials[1];

			intro.add(players[i]);
			players[i].play("jump");
			players[i].position.x = (i*60)-90;

			grounds[i] = new THREE.Mesh(new THREE.PlaneGeometry( 56, 56 ), materials[20+i]);
			intro.add(grounds[i]);
			grounds[i].rotation.x = - Math.PI / 2 ;
			grounds[i].position.y = -2;
			grounds[i].position.x = (i*60)-90;
			grounds[i].castShadow = false;
			grounds[i].receiveShadow = true;
			grounds[i].name = "G"+ i;
		}
		
		isIntro=true;
		document.addEventListener( 'mousemove', onDocumentMouseMove, false );
		document.addEventListener( 'mousedown', onDocumentMouseDown, false );
		startRender();
	}

	function intro3DIdle(){
		if(players.length>0){
			for (var i = 0; i<4; i++){
				if(players[i].currentAnimation.name !== "idle") players[i].play("idle");
			}
	    }
	}

	function clear3Dintro(){
		stopRender();
		var obj, i;
		for ( i = intro.children.length - 1; i >= 0 ; i -- ) {
			obj = intro.children[ i ];
			intro.remove(obj);
			if(obj.animations) obj.stop();
			obj.geometry.dispose();
		}
		scene.remove(intro);
		intro = null;
		isIntro=false;
		document.removeEventListener( 'mousemove', onDocumentMouseMove );
		document.removeEventListener( 'mousedown', onDocumentMouseDown );
	}

	//===========================================================================
	//
	// ENTITIES TRANSPHERE oo
	//
	//===========================================================================

	function entities3DInfo(entities, frame) {
		if(!viewConfig.showInfo) return;
		var t = "Entity lenght:" + entities.length + "<br>";
		var n, max, entity;
		var numMonster = 0;
		var numWeapon = 0;
		var numTreasure = 0;
		var numFx = 0;
		var numGenerator = 0;
		var numDoor = 0;
		var numExit =0;

		for(n = 0, max = entities.length ; n < max ; n++) {
			entity = entities[n];
			if(entity.monster){numMonster++;}
			if(entity.weapon){numWeapon++;}
			if(entity.treasure){numTreasure++;}
			if(entity.fx){numFx++;}
			if(entity.generator){if(entity.type.sx>31)numGenerator++;}
			if(entity.door){numDoor++;}
			if(entity.exit){numExit++;}
		}

		/*list = t  + "Monster:"+numMonster+"<br>"+ "Weapon:"+numWeapon+"<br>"+ "Treasure:"+numTreasure+"<br>"+ "Fx:"+numFx+"<br>"+ "Generator:"+numGenerator+"<br>"+ "Door:"+numDoor+"<br>"+ "Exit:"+numExit+"<br>"+"Frame"+ frame;*/
		tell(list);
	}

	function entitiesTo3D( entities ) {
		var n, max, entity;
		for(n = 0, max = entities.length ; n < max ; n++) {
			entity = entities[n];

			if(entity.monster) monster3D(n, entity);
			if(entity.generator){ if(entity.type.sx>31) generator3D(n, entity); }

			if(entity.treasure) Treasure3D(n, entity); 
			if(entity.door) door3D(n, entity );
			if(entity.exit) exit3D(n, entity ); 

			if(entity.weapon) weapon3D(n, entity ); 
			if(entity.fx) fx3D(n, entity );
		}
	}

	function entities3D( entity , n) {

		if(entity.monster) monster3D(n, entity);
		if(entity.generator){ if(entity.type.sx>31){ generator3D(n, entity); }}
		// fixe and remove
		if(entity.treasure) Treasure3D(n, entity);
		if(entity.door) door3D(n, entity );
		// fixe
		if(entity.exit) exit3D(n, entity);
		// move and pool
		if(entity.weapon) weapon3D(n, entity );
		if(entity.fx) fx3D(n, entity );
	}

	//===========================================================================
	// THE MAP ++
	//===========================================================================

	function init3DLevel(){
		if(intro)clear3Dintro();
		if(level)clear3DLevel();
		level = new THREE.Object3D();
		scene.add(level);

		startRender();
	}

	function clear3DLevel(){
		stopRender();
		var obj, i;
		for ( i = level.children.length - 1; i >= 0 ; i -- ) {
			obj = level.children[ i ];
			level.remove(obj);
			if(obj.animations) obj.stop();
			obj.geometry.dispose();
		}

		generator.length = 0;
		treasure.length = 0;
		monster.length = 0;
		weapon.length = 0;
		exit.length = 0;
		door.length = 0;
		fx.length = 0;

		tEntities.length = 0;

		scene.remove(level);
		level = null;
	}

	function add3DWall(x, y, sx, sy) {
		var geo = meshs[sx].geometry; // get reference wall * 16
		var block = new THREE.Mesh( geo, materials[2]);
		block.scale.set( 1, 1, -1 );
		block.position.set( x*32, 0, y*32 );
		level.add(block);
		block.castShadow = true;
		block.receiveShadow = true;
	}

	function add3DFloor(x, y, sx, sy) {
		if(sy!=0) return; //no need shadow cell
		var geo = meshs[36].geometry;
		var block = new THREE.Mesh( geo, materials[3]);
		block.scale.set( 1, 1, -1 );
		block.position.set( x*32, 0, y*32 );
		level.add(block);
		block.castShadow = false;
		block.receiveShadow = true;
	}

	//===========================================================================
	// 3D PLAYER
	//===========================================================================

	function init3DPlayer(type) {
		player = meshs[27+type.sy];
		player.play('idle');
		scene.add(player);
	}

	function remove3DPlayer() {
		scene.remove(player);
		player.stop();
		player.geometry.dispose();
	}

	function move3DPlayer( ee ) {
	    if(player){

			player.rotation.y = degToRad((-ee.dir*45)+180);
			player.position.set(ee.x, 25, ee.y);
			target.position.set(ee.x, 25, ee.y);

			if(ee.moving.dir!=null && player.currentAnimation.name == "idle") player.play('walk');
			else if( ee.moving.dir == null && player.currentAnimation.name == "walk") player.play('idle');
			else if( ee.health === 0 && player.currentAnimation.name !== "death") player.play('death');

			//player info for animation
			//tell("Fire:"+pp.firing+"<br>"+"Move:"+pp.moving.dir+"<br>"+"Hurt:"+pp.hurting+"<br>"+"Dead:"+pp.dead+"<br>"+ player.currentAnimation.name);
		}
	}

	//===========================================================================
	// 3D EXIT ++
	//===========================================================================

	function exit3D(n, ee) {
		if(!exit[n]){
			var geo = meshs[26].geometry;
			var block = new THREE.Mesh( geo, materials[7]);
			block.scale.set( 1, 1, -1 );
			block.position.set(ee.x, 0, ee.y);
			block.castShadow = block.receiveShadow = true;
			level.add(block);
			exit[n] = block;
		}
	}

	//===========================================================================
	// 3D TREASURE ++
	//===========================================================================

	function Treasure3D(n, ee) {
		if(!treasure[n]){
			var geo = meshs[ee.type.sx+16].geometry;
			var block = new THREE.Mesh( geo, materials[8] );
			block.scale.set( 1, 1, -1 );
			block.position.set(ee.x, 0, ee.y);
			block.castShadow = block.receiveShadow = true;
			level.add(block);
			treasure[n] = block;
			//list += "Treasure "+ n +" add<br>";
		} else {
			if (!ee.active && treasure[n].castShadow){ 
				treasure[n].castShadow = treasure[n].receiveShadow = false;
				level.remove(treasure[n]);
				//list += "Treasure "+ n +" removed<br>";
            }
		}
	}

	//===========================================================================
	// 3D DOOR ++
	//===========================================================================

	function door3D(n, ee) {
		if(!door[n]){
			var geo; 
			if(ee.type.sx === 10) { geo = meshs[24].geometry; }
			else { geo = meshs[25].geometry; }

			var block = new THREE.Mesh( geo, materials[7]);
			block.scale.set( 1, 1, -1 );
			block.position.set(ee.x, 0, ee.y);
			block.castShadow = block.receiveShadow = true;
			level.add(block);
			door[n] = block;
			//list += "Door "+ n +" add<br>";
		} else {
			if (!ee.active && door[n].castShadow){
				door[n].castShadow = door[n].receiveShadow = false;
			    level.remove(door[n]);
			    //list += "Door "+ n +" removed<br>";
			}
		}
	}

	//===========================================================================
	// 3D GENERATOR
	//===========================================================================

	var genGeo = new THREE.CubeGeometry( 32, 60, 32 );

	function generator3D(n, ee) {
		if(!generator[n]){
			generator[n] = new THREE.Mesh( genGeo, materials[11] );//materials[ee.type.sy+19]);
			generator[n].position.set(ee.x, 30, ee.y);
			level.add( generator[n] );
			generator[n].castShadow = true;
			generator[n].receiveShadow = true;
		} else {
			if (!ee.active && generator[n].castShadow){ 
				generator[n].castShadow = false;
				generator[n].receiveShadow = false;
				level.remove(generator[n]);
			}
		}
	}

	/*function remove3DGenerator(n) {
		if(generator[n]){
			level.remove(generator[n]);
			generator[n].geometry.dispose();
		}
	}*/

	
	//===========================================================================
	// 3D MONSTER
	//===========================================================================

	function monster3D(n, ee) {
		if(!monster[n]){
			var block = meshs[27+ee.type.sy].clone(); //loader.getMesh(meshs[27+ee.type.sy].name).clone();
			if( ee.type.sy == 4 || ee.type.sy == 5 ) block.material = materials[4];
			else if( ee.type.sy == 6 || ee.type.sy == 7 ) block.material = materials[5];
			else block.material = materials[6];
			//var block = new THREE.SkinnedMesh( meshs[27+ee.type.sy].geometry.clone(), meshs[27+ee.type.sy].material, false);
			//block.scale.set( 1, 1, -1 );
			//block.animations = meshs[27+ee.type.sy].animations;
			//var animation = new THREE.Animation( block, "idle" );
			//THREE.AnimationHandler.add( block.geometry.animations );
			block.play("idle");
			block.castShadow = block.receiveShadow = true;
			level.add( block );
			monster[n] = block;
		} else {
			if(monster[n].currentAnimation.name !== "stop"){
			    monster[n].rotation.y = degToRad((-ee.dir*45)+180);
			    if(ee.type.sy == 6) monster[n].position.set(ee.x, 5, ee.y); // dog
			    else 
			    monster[n].position.set(ee.x, 25, ee.y);
		    }
			if(ee.thinking == 0 && monster[n].currentAnimation.name == "idle") monster[n].play('walk');
			else if( ee.thinking > 0 && monster[n].currentAnimation.name == "walk") monster[n].play('idle');
			//else if (ee.health < 1 && monster[n].currentAnimation.name !== "death") monster[n].play('death');
			else if(!ee.active && monster[n].currentAnimation.name !== "stop") monster[n].play('stop');
		}
	}

	//===========================================================================
	// 3D FX
	//===========================================================================

	var fxGeo = new THREE.PlaneGeometry( 30, 30 );

	function fx3D(n, ee) {
		if(!fx[n]){
		    fx[n] = new THREE.Mesh( fxGeo, materials[9]);
		    fx[n].rotation.x = - Math.PI / 2 ;
			level.add(fx[n]);
		} else {
			//if(ee.type.sx === 13) fx[n].material =  materials[27];
		    //else if(ee.type.sx === 19) fx[n].material =  materials[29];
		    fx[n].position.set(ee.x, 20, ee.y);
		}
	}

	//===========================================================================
	// 3D WEAPON
	//===========================================================================

	var WaponGeo = new THREE.CubeGeometry( 10, 5, 5 );

	function weapon3D(n, ee) {
		if(!weapon[n]){
			weapon[n] = new THREE.Mesh(WaponGeo, materials[10]);
			//weapon[n].material = materials[0];
			level.add(weapon[n]);
		} else {
			weapon[n].rotation.y = degToRad((-ee.dir*45)+90);
		    weapon[n].position.set(ee.x, 20, ee.y);
		}
	}

	//===========================================================================

	//-----------------------------------------------------
	//  TOOLS
	//-----------------------------------------------------

	function tell(Value) {
		document.getElementById('debug').innerHTML = Value;
	}

	//-----------------------------------------------------
	//  MATH
	//-----------------------------------------------------

	function degToRad(Value) {
		return Value * Math.PI / 180;
	}

	function Orbit(origine, horizontal, vertical, distance) {
		var p = new THREE.Vector3();
		var phi = degToRad( horizontal );
		var theta = degToRad( vertical );
		p.x = (distance * Math.sin(phi) * Math.cos(theta)) + origine.x;
		p.z = (distance * Math.sin(phi) * Math.sin(theta)) + origine.z;
		p.y = (distance * Math.cos(phi)) + origine.y;
		return p;
	}

	//-----------------------------------------------------
	//  GUI
	//-----------------------------------------------------

	function addGUI() {
		gui = new dat.GUI({autoPlace:false, width:204});
		document.getElementById('gui').appendChild(gui.domElement);
		gui.open();
	}

	function addGUIView() {
		var f4 = gui.addFolder('View Option');
		f4.add( viewConfig, 'show2d' ).onChange( function() {
			if(viewConfig.show2d)document.getElementById("canvas").style.visibility = "visible"; 
			else document.getElementById("canvas").style.visibility = "hidden";
			window.game.no2d(viewConfig.show2d);
		});
		f4.add( viewConfig, 'showInfo' ).onChange( function() { if(!viewConfig.showInfo) list = "";});
		f4.open();
	}

	function addGUICamera() {
		var f5 = gui.addFolder('Camera Option');
		f5.add( camConfig, 'horizontal', 0, 360 ).onChange( function() {  });
		f5.add( camConfig, 'vertical', 0, 360 ).onChange( function() {  });
		f5.add( camConfig, 'distance', 50, 500 ).onChange( function() {  });
		f5.open();
	}

	//window.onload = init;
	Game.run(Gauntlet);
</script>
</body>
</html>