<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
	<link href="css/loth.css" rel="stylesheet" type="text/css"  />
	<title>Javascript Gauntlet 3D</title>
</head>

<body>
<div id="viewport"></div>
<div id="hubs">
	<div id="debug"></div>
	<div id="gui"></div>
	<div id="home"><a href="index.html"><img id="logo" src="res/img/home.png" onmouseover="this.src='res/img/home_s.png'" onmouseout="this.src='res/img/home.png'" /></a></div>
	<div id="info">
	GAUNTLET 3D 0.1a <a href="http://3dflashlo.wordpress.com/" target="_blank">Â®loth 2013</a>
	| <a href="https://code.google.com/p/sea3d/" target="_blank">sea3d</a> 
	. <a href="http://github.com/mrdoob/three.js" target="_blank">three.js</a> 
	| <a href="https://github.com/jakesgordon/javascript-gauntlet/" target="_blank">Gauntlet source</a> 
	</div>
	<div id="loading"><img src="res/img/loader.gif" alt="Loading SEA3D File." style="visibility: hidden;"></div>
</div>
<div id="my-stat"></div>
<div  id='buttonMenu'>
<div  id='button' onclick='test3D( "monster", 100, 6, 2);'>TEST MONSTER 01</div>
<div  id='button' onclick='test3D( "monster", 200, 7, 2);'>TEST MONSTER 02</div>
<div  id='button' onclick='test3D( "object", 1000, 26, 3);'>TEST OBJECT 01</div>
<div  id='button' onclick='test3D( "object", 4000, 23, 4);'>TEST OBJECT 02</div>
<div  id='button' onclick='intro3D();'>TEST INTRO</div>
</div>

<!-- _     _   _      ___ __  _ ____
    | |___| |_| |__  |_  )  \/ |__ /
    | / _ \  _|    |  / / () | ||_ \
    |_\___/\__|_||_| /___\__/|_|___/
--> 

<script src="js/three.min.js"></script>
<script src="js/BufferGeometryUtils.js"></script>
<script src='js/threex.rendererstats.js'></script>

<script src="js/loaders/sea3d/SEA3D.js"></script>
<script src="js/loaders/sea3d/SEA3DLoader.js"></script>
<script src="js/loaders/sea3d/SEA3DDeflate.js"></script>
<script src="js/loaders/sea3d/SEA3DLZMA.js"></script>

<script src="js/gauntlet/vendor.js"></script>

<script src='js/libs/dat.gui.min.js'></script>

<script>
	var vsize = { x:100, y:100, z:0 };
	var mouse = { x:0, y:0, move:true };
	var camera, controls, target, scene, renderer, composer, renderPass, delta, pointLight, pointLight2, spotLight, renderLoop;
	var clock = new THREE.Clock();
	var Colors= [0x161616, 0xaaaaaa, 0xffffff];
	var stats, rendererStats;

	var materials = [];

	var generator = [];
	var treasure = [];
	var monster = [];
	var weapon = [];
	var exit = [];
	var door = [];
	var fx = [];

	var players = [];
	var grounds = [];

	var loader;

	var tEntities = [];

	

	var level, player, intro, test;
	var meshs=[];

	var list ="";

	var projector, raycaster;
	var mouse = new THREE.Vector2(), INTERSECTED;
	var radius = 100, theta = 0;
	var isIntro;

	var viewConfig = {
		show2d : false,
		showInfo : false
	}

	var camConfig = {
		horizontal : 45,
		vertical : 90,
		distance : 200
	}

	/*function init() {
		//initScene3D();
		document.getElementById("canvas").style.visibility = "hidden";
		//document.getElementById("scoreboard").style.visibility = "hidden";
		tell("<b>1,2,3,4</b> choose player<br><b>ARROW</b> keys to move<br><b>HOLD SPACE</b> to fire<br><b>ENTER</b> to use potion");
	}*/

	function init3D() {
		if(!renderer){
			setTimeout(initScene3D, 100);
			//tell("<b>Choose player</b> <br><b>ARROW</b> keys to move<br><b>HOLD SPACE</b> to fire<br><b>ENTER</b> to use potion");

			stats = new Stats();
			stats.domElement.style.position	= 'absolute'
			stats.domElement.style.left	= '0px'
			stats.domElement.style.bottom	= '151px'
			document.body.appendChild( stats.domElement );


			rendererStats = new THREEx.RendererStats();
			rendererStats.domElement.style.position	= 'absolute'
			rendererStats.domElement.style.left	= '0px'
			rendererStats.domElement.style.bottom	= '0px'
			document.body.appendChild( rendererStats.domElement );

			document.getElementById("debug").style.left = "75px";
		}
	}

	function initScene3D() {
		vsize.x = window.innerWidth;
		vsize.y = window.innerHeight-31;
		vsize.z = vsize.x / vsize.y;

		renderer = new THREE.WebGLRenderer({ antialias: false, alpha: false });
		renderer.setSize( vsize.x, vsize.y );
		renderer.setClearColor( Colors[0], 1 );
		//renderer.physicallyBasedShading = true;
		renderer.gammaInput = true;
		renderer.gammaOutput = true;
		renderer.shadowMapEnabled = true;
		//renderer.shadowMapCascade = true;
		//renderer.shadowMapType = THREE.PCFSoftShadowMap;
		//renderer.shadowMapSoft = true;
		//renderer.sortObjects = false;
		//renderer.shadowMapCullFace = THREE.CullFaceBack;

		document.getElementById( 'viewport' ).appendChild( renderer.domElement );
		renderer.domElement.style.top = 31 + "px";
		renderer.domElement.style.position = "absolute";

		// SCENE
		scene = new THREE.Scene();
		//scene.fog = new THREE.Fog(  Colors[0], 300, 500 );

		projector = new THREE.Projector();
		raycaster = new THREE.Raycaster();

		// CAMERA
		camera = new THREE.PerspectiveCamera( 70, vsize.z, 1, 2000 );
		camera.position.z = 100;
		camera.position.y = 200;
		//scene.add(camera);

		target = new THREE.Object3D();
		scene.add(target);
		
		var ambient = new THREE.AmbientLight(  Colors[0] );
		scene.add( ambient );

		//spotLight = new THREE.DirectionalLight(0x000, 1.5);
		spotLight = new THREE.SpotLight( 0xffffff );
		spotLight.intensity = 2;
		spotLight.position.set(100,200,50);
		spotLight.target = target;
		spotLight.castShadow = true;

		spotLight.shadowCameraNear = 100;
		spotLight.shadowCameraFar = 300;
		spotLight.shadowCameraFov = 75;

		spotLight.shadowMapBias = 0.01;
		spotLight.shadowMapDarkness = 0.7;
		spotLight.shadowMapWidth = 1024;
		spotLight.shadowMapHeight = 1024;

		/*spotLight.shadowCascade = true;
		spotLight.shadowCascadeCount = 3;
		spotLight.shadowCascadeNearZ = [ -1.000, 0.995, 0.998 ];
		spotLight.shadowCascadeFarZ  = [  0.995, 0.998, 1.000 ];
		spotLight.shadowCascadeWidth = [ 1024, 1024, 1024 ];
		spotLight.shadowCascadeHeight = [ 1024, 1024, 1024 ];*/
		//spotLight.shadowCameraVisible = true; 

		//spotLight.onlyShadow= true;
		target.add(spotLight);
		//scene.add(spotLight);


	    pointLight = new THREE.PointLight( 0xffffff, 1, 200 );
		pointLight.position.set( 0, 30, 0 );
		target.add( pointLight );

		/*pointLight2 = new THREE.PointLight( 0xffffff, 3, 150 );
		pointLight2.position.set( 0, 0, 0 );
		target3.add( pointLight2 );*/


		initMaterial();
		initSea3DMesh();

		addGUI();
		//addGUIView();
		addGUICamera();

		window.addEventListener( 'resize', onResize, false );
	}

	//===========================================================================
	// RENDER LOOP
	//===========================================================================

	function startRender() {
		if(!renderLoop) renderLoop = setInterval( function () { requestAnimationFrame( animate ); }, 1000 / 60 );
	}

	function stopRender() {
		if(renderLoop) {clearInterval(renderLoop); renderLoop = null;}
	}

	function animate() {
		//requestAnimationFrame( animate );
		delta = clock.getDelta();
		THREE.AnimationHandler.update( delta );
		
		camera.position.copy( Orbit( target.position, camConfig.horizontal, camConfig.vertical, camConfig.distance ) );
		camera.lookAt( target.position );

		renderer.render( scene, camera );

		// find intersections if intro
		if(isIntro){
			var vector = new THREE.Vector3( mouse.x, mouse.y, 1 );
			projector.unprojectVector( vector, camera );
			raycaster.set( camera.position, vector.sub( camera.position ).normalize() );
			var intersects = raycaster.intersectObjects( intro.children );

			if ( intersects.length > 0 ) {
				if ( INTERSECTED != intersects[ 0 ].object ) {
					if ( INTERSECTED ){ 
						INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
						intro3DIdle();
					}
					INTERSECTED = intersects[ 0 ].object;
					INTERSECTED.currentHex = INTERSECTED.material.emissive.getHex();
					INTERSECTED.material.emissive.setHex( 0xff0000 );
					//list = ("select "+INTERSECTED.name);
					if(players.length>0){
						if ( INTERSECTED.name === "G0" )if(players[0].currentAnimation.name !== "walk") players[0].play("walk");
						if ( INTERSECTED.name === "G1" )if(players[1].currentAnimation.name !== "walk") players[1].play("walk");
						if ( INTERSECTED.name === "G2" )if(players[2].currentAnimation.name !== "walk") players[2].play("walk");
						if ( INTERSECTED.name === "G3" )if(players[3].currentAnimation.name !== "walk") players[3].play("walk");
				    }
				}
			} else {
				if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
				INTERSECTED = null;
				intro3DIdle();
			}
		}

		//tell(list);
		stats.update();
		rendererStats.update(renderer);
	}

	//===========================================================================
	// LISTENERS
	//===========================================================================

	function onResize( event ) {
		vsize.x = window.innerWidth;
		vsize.y = window.innerHeight-31;
		vsize.z = vsize.x / vsize.y;
		camera.aspect = vsize.z;
		camera.updateProjectionMatrix();
		renderer.setSize( vsize.x, vsize.y );
	}

	function onDocumentMouseMove( event ) {
		event.preventDefault();
		mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
		mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
	}

	function onDocumentMouseDown( event ) {
		if(isIntro && INTERSECTED !== null ){
			/*if ( INTERSECTED.name === "G0" ) window.game.playPlayer(0);
			if ( INTERSECTED.name === "G1" ) window.game.playPlayer(1);
			if ( INTERSECTED.name === "G2" ) window.game.playPlayer(2);
			if ( INTERSECTED.name === "G3" ) window.game.playPlayer(3);*/
		}
	}

	//===========================================================================
	//
	// MATERIALS
	//
	//===========================================================================

	function initMaterial( ) {
	    

	    materials[0] = makeMaterial("avatar1.jpg", null, true);// player 0 / 1;
		materials[1] = makeMaterial("avatar2.jpg", null, true);// player 2 / 3;

	    materials[2] = makeMaterial(null, null, true, 60, 0xea9a9a);
	    materials[3] = makeMaterial('stairs.jpg', null, false, 60);
	    materials[4] = makeMaterial(null, null, false, 60, 0xffff00);


	    materials[10] = makeMaterial(null, null, false, 250, Colors[0]);// ground test

	    materials[20] = makeMaterial(null, null, false, 60, 0xF90503);
		materials[21] = makeMaterial(null, null, false, 60, 0x08B4F0);
		materials[22] = makeMaterial(null, null, false, 60, 0xF5FC00);
		materials[23] = makeMaterial(null, null, false, 60, 0x00FF03);

	}

	function makeMaterial (diffuse, normal, skin, shine, color){
		var map, map2;
		var material = new THREE.MeshPhongMaterial( { ambient: Colors[1], specular: Colors[2], shininess: shine || 60 } );

		if(diffuse) {
			map = THREE.ImageUtils.loadTexture( 'res/textures/game/'+ diffuse );
		    map.repeat.set( 1, -1 );
		    map.wrapS = map.wrapT = THREE.RepeatWrapping;
		    map.anisotropy = renderer.getMaxAnisotropy();
		    material.map = map;
		}

		if(normal) {
			map2 = THREE.ImageUtils.loadTexture( 'res/textures/game/'+ normal );
		    map2.repeat.set( 1, -1 );
		    map2.wrapS = map2.wrapT = THREE.RepeatWrapping;
		    map2.anisotropy = renderer.getMaxAnisotropy();
		    material.normalMap = map2;
		    material.normalScale.x = material.normalScale.y = 2;
		}

		if(skin) material.skinning = true;
		if(color) material.color.setHex( color );

		return material;
	}

	//===========================================================================
	// IMPORT SEA3D ASSETS
	//===========================================================================

	function initSea3DMesh() {

		//var 
		loader = new THREE.SEA3D( false );
		var size = 1;
		var i;
		//list = "";

		loader.onComplete = function( e ) {
			// 0 -> 15 walls
			// 16 -> 23 treasure
			// 24 - 25 doors
			// 26 exit
			// 27 -> 30 Hero 
			// 31 -> 35 Monster 
			// 36 - floor
			for (i=0; i < loader.meshes.length; i++){
				meshs[i] = loader.meshes[i];
				if(meshs[i].name !== "weapon0" && meshs[i].name !== "weapon1" && meshs[i].name !== "weapon2" && meshs[i].name !== "weapon3") 
					meshs[i].scale.set( size, size, -size );
				//list += i + ":"+meshs[i].name+"<br>";
			}
			//tell(list);
		//	testMonster3D( "monster", 100, 6);
		};
		loader.load( 'res/models/gauntlet_dog_nomat.sea' );
	}

	//===========================================================================
	// TEST
	//===========================================================================

	function test3D(type, number, n, matNumber){

		if(test)clear3DMonsterTest();
		if(intro)clear3Dintro();


		test = new THREE.Object3D();
		scene.add(test); 
		var colone = 20;
		var space = 50;
		var line = number/colone;
		var lineDeg = (line*space)/360;
		var coloneDeg = (colone*space)/360;
		var startX = ((colone*space)*0.5) - (space*0.5);
		var startY = ((line*space)*0.5) - (space*0.5);
		var posY = 25;
		if(n == 6) posY = 5;
		var geo ,mesh;
		var material = materials[matNumber];
		var pos = new THREE.Vector3(0,0,0);
		var up = new THREE.Vector3(0,0,1);

		if(type == "monster") mesh = loader.getMesh(meshs[27+n].name);
		if(type == "object"){ geo = meshs[n].geometry; posY=0;}


		//var gg = new THREE.BufferGeometryUtils.fromGeometry(meshs[26].geometry);
		// = meshs[26].geometry;
		//var gg = meshs[27+n].geometry;
		//var anim = meshs[27+n].geometry.animations;
		//var bones = meshs[27+n].bones;
		/*var texture = THREE.ImageUtils.loadTexture( 'res/textures/game/stairs.jpg' );
		texture.repeat.set( 1, -1 );
		texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
		texture.anisotropy = renderer.getMaxAnisotropy();
		 new THREE.MeshPhongMaterial( {
						ambient: 0xaaaaaa, specular: 0xffffff, shininess: 250, map: texture, skinning: true
						//side: THREE.DoubleSide, vertexColors: THREE.VertexColors
				} );*/


		for(var j=0; j<line; j++){
            for(var i=0; i<colone; i++){


				//var block = new THREE.Mesh(gg,  materials[0]);//
				//var block = new THREE.SkinnedMesh(gg, material, false);
				//block.material.skinning = true;
				//block.bones = bones;
				//block.animations = anim;
				
				//block.addAnimations( anim );
				/*block.animations = {};
				for (var i in anim) {
					block.animations[i] = new THREE.Animation( block, anim[i].data.name );
					block.animations[i].loop = anim[i].loop;
					block.animations[i].name = anim[i].name;


				}*/
				//block.activeAnimation = true;
				//block.addAnimations( block.animations );
/*
				var nsIndex = block.animations[0].name.indexOf("/")+1;
				block.animationNamespace = block.animations[0].name.substring(0, nsIndex);
				for (var i in block.animations) {								
		THREE.AnimationHandler.add( block.animations[i] );
	}*/
					//THREE.AnimationHandler.add( block.animations[i] );

				//block.animations = anim;
			//	tell(block.bones.length)
				/*for (var i in block.animations) {
					THREE.AnimationHandler.add( block.animations[i] );	
				}*/
				var block;

				if(mesh){
					block = mesh.clone();
					block.material = material;
					block.play("walk", Math.random()*100);
				}
				else block = new THREE.Mesh(geo,  material);
				block.scale.set( 1, 1, -1 );
				block.position.set(startX- i *space, posY, startY - j*space);


				//block.position.copy( Orbit(pos, Math.random()*360, Math.random()*360, 100+posY) )
				//block.up.set( 1, 1, -1 );
				//block.lookAt(pos);
				//block.geometry.applyMatrix( new THREE.Matrix4().makeRotationY( degToRad(90) ) );
				//block.geometry.matrixRotationWorld.y = 
				//block.rotation.y += degToRad(90);
				//block.rotation.x += degToRad(90);;;
				//block.rotation.z += degToRad(90)


				

				block.castShadow = block.receiveShadow = true;
				test.add( block );
				monster[i] = block;
			}
		}

		grounds[0] = new THREE.Mesh(new THREE.PlaneGeometry( (colone*space)+space, (line*space)+space ), materials[10]);
		grounds[0].rotation.x = - Math.PI / 2 ;
		grounds[0].castShadow = false;
		grounds[0].receiveShadow = true;
		test.add(grounds[0]);
		startRender();

		tell('add '+number);
	}

	function clear3DMonsterTest(){
		var obj, i;
		tell('remove '+test.children.length);
		for ( i = test.children.length - 1; i >= 0 ; i -- ) {
			obj = test.children[ i ];
			test.remove(obj);
			if(obj.animations) obj.stop();
			obj.geometry.dispose();
		}

		scene.remove(test);
		//test.dispose();
		test = null;
		stopRender();
	}

	//===========================================================================
	// INTRO
	//===========================================================================

	function intro3D(){
		if(test)clear3DMonsterTest();
		if(intro)clear3Dintro();
		
		intro = new THREE.Object3D();
		scene.add(intro);

		for (var i = 0; i<4; i++){
			players[i] = meshs[27+i];
			if(i===27 || i===28) players[i].material = materials[0];
			else players[i].material =  materials[1];

			intro.add(players[i]);
			players[i].play("jump");
			players[i].position.x = (i*60)-90;

			grounds[i] = new THREE.Mesh(new THREE.PlaneGeometry( 56, 56 ), materials[20+i]);
			intro.add(grounds[i]);
			grounds[i].rotation.x = - Math.PI / 2 ;
			grounds[i].position.y = -2;
			grounds[i].position.x = (i*60)-90;
			grounds[i].castShadow = false;
			grounds[i].receiveShadow = true;
			grounds[i].name = "G"+ i;
		}
		
		isIntro=true;
		document.addEventListener( 'mousemove', onDocumentMouseMove, false );
		document.addEventListener( 'mousedown', onDocumentMouseDown, false );
		startRender();
	}

	function intro3DIdle(){
		if(players.length>0){
			for (var i = 0; i<4; i++){
				if(players[i].currentAnimation.name !== "idle") players[i].play("idle");
			}
	    }
	}

	function clear3Dintro(){
		stopRender();
		var obj, i;
		for ( i = intro.children.length - 1; i >= 0 ; i -- ) {
			obj = intro.children[ i ];
			intro.remove(obj);
			if(obj.animations) obj.stop();
			obj.geometry.dispose();
		}
		scene.remove(intro);
		intro = null;
		isIntro = false;
		document.removeEventListener( 'mousemove', onDocumentMouseMove );
		document.removeEventListener( 'mousedown', onDocumentMouseDown );
	}

	//===========================================================================

	//-----------------------------------------------------
	//  TOOLS
	//-----------------------------------------------------

	function tell(Value) {
		document.getElementById('debug').innerHTML = Value;
	}

	//-----------------------------------------------------
	//  MATH
	//-----------------------------------------------------

	function degToRad(Value) {
		return Value * Math.PI / 180;
	}

	function Orbit(origine, horizontal, vertical, distance) {
			var p = new THREE.Vector3();
			var phi = degToRad( horizontal );
			var theta = degToRad( vertical );
			p.x = (distance * Math.sin(phi) * Math.cos(theta)) + origine.x;
			p.z = (distance * Math.sin(phi) * Math.sin(theta)) + origine.z;
			p.y = (distance * Math.cos(phi)) + origine.y;
			return p;
	}

	//-----------------------------------------------------
	//  GUI
	//-----------------------------------------------------

	function addGUI() {
		gui = new dat.GUI({autoPlace:false, width:204});
		document.getElementById('gui').appendChild(gui.domElement);
		gui.open();
	}

	function addGUIView() {
		var f4 = gui.addFolder('View Option');
		f4.add( viewConfig, 'show2d' ).onChange( function() {
			if(viewConfig.show2d)document.getElementById("canvas").style.visibility = "visible"; 
			else document.getElementById("canvas").style.visibility = "hidden";
			window.game.no2d(viewConfig.show2d);
		});
		f4.add( viewConfig, 'showInfo' ).onChange( function() { if(!viewConfig.showInfo) list = "";});
		f4.open();
	}

	function addGUICamera() {
		var f5 = gui.addFolder('Camera Option');
		f5.add( camConfig, 'horizontal', 0, 360 ).onChange( function() {  });
		f5.add( camConfig, 'vertical', 0, 360 ).onChange( function() {  });
		f5.add( camConfig, 'distance', 50, 500 ).onChange( function() {  });
		f5.open();
	}

	window.onload = init3D;
	//Game.run(Gauntlet);
</script>
</body>
</html>